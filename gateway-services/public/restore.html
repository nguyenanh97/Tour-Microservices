<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Khôi phục tài khoản</title>
    <!-- giảm rò referrer -->
    <meta name="referrer" content="no-referrer" />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 680px;
        margin: 48px auto;
        color: #222;
      }
      .box {
        padding: 24px;
        border: 1px solid #eee;
        border-radius: 6px;
      }
      .ok {
        color: green;
      }
      .err {
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <h2>Khôi phục tài khoản</h2>
      <p id="status">Đang xử lý khôi phục tài khoản...</p>
    </div>

    <script>
      (function () {
        function qs(name) {
          return new URLSearchParams(window.location.search).get(name);
        }
        const statusEl = document.getElementById('status');
        const token = qs('token');
        if (!token) {
          statusEl.className = 'err';
          statusEl.textContent =
            'Token bị thiếu. Vui lòng kiểm tra link trong email.';
          return;
        }

        // Gửi POST tới auth-service để thực hiện restore (token trong body)
        fetch('/api/v1/auth/restore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token }),
          credentials: 'same-origin', // nếu bạn dùng cookie-based auth
        })
          .then(async res => {
            let payload;
            try {
              payload = await res.json();
            } catch (e) {
              payload = null;
            }
            if (res.ok && payload && payload.status === 'success') {
              statusEl.className = 'ok';
              statusEl.innerHTML =
                'Tài khoản đã được khôi phục. Bạn đã được đăng nhập.';
              // xóa token khỏi URL history để tránh lưu trong lịch sử
              try {
                history.replaceState(null, '', window.location.pathname);
              } catch (e) {}
            } else {
              statusEl.className = 'err';
              statusEl.innerHTML =
                'Không thể khôi phục: ' +
                (payload && payload.message ? payload.message : res.statusText);
            }
          })
          .catch(err => {
            statusEl.className = 'err';
            statusEl.textContent = 'Lỗi khi gọi service: ' + err.message;
            console.error(err);
          });
      })();
    </script>
  </body>
</html>
